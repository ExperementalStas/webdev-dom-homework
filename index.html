<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <div class="loading">Загрузка комментариев...</div>
      <ul class="comments"></ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя" />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш комментарий"
          rows="4"></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>

      <div class="add-form-loading" style="display: none">
        Комментарий добавляется...
      </div>
    </div>
  </body>
  <script>
    "use strict";

    const commentsList = document.querySelector(".comments");
    const nameInput = document.querySelector(".add-form-name");
    const textInput = document.querySelector(".add-form-text");
    const addButton = document.querySelector(".add-form-button");
    const loadingElement = document.querySelector(".loading");
    const addFormElement = document.querySelector(".add-form");
    const addFormLoadingElement = document.querySelector(".add-form-loading");

    const API_URL = "https://wedev-api.sky.pro/api/v1/ivan-ivanov/comments";
    let comments = [];

    async function fetchComments() {
      try {
        loadingElement.style.display = "";
        addFormElement.style.display = "none";
        addFormLoadingElement.style.display = "none";

        const response = await fetch(API_URL);
        if (!response.ok) {
          throw new Error("Ошибка при загрузке комментариев");
        }
        const data = await response.json();
        comments = data.comments.map((comment) => ({
          author: comment.author.name,
          date: new Date(comment.date),
          text: comment.text,
          likes: comment.likes,
          isLiked: comment.isLiked,
          id: comment.id,
        }));
        renderComments();
      } catch (error) {
        console.error("Ошибка:", error);
        alert("Не удалось загрузить комментарии. Попробуйте позже.");
      } finally {
        loadingElement.style.display = "none";
        addFormElement.style.display = "";
      }
    }

    async function postComment() {
      const author = nameInput.value.trim();
      const text = textInput.value.trim();

      if (author === "" || text === "") {
        alert("Пожалуйста, заполните все поля");
        return;
      }

      if (author.length < 3 || text.length < 3) {
        alert("Имя и комментарий должны содержать минимум 3 символа");
        return;
      }

      try {
        addFormElement.style.display = "none";
        addFormLoadingElement.style.display = "";

        const response = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            text: text,
            name: author,
          }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || "Ошибка при отправке комментария");
        }

        await fetchComments(); 
        nameInput.value = "";
        textInput.value = "";
      } catch (error) {
        console.error("Ошибка:", error);
        alert(error.message);
      } finally {
        addFormLoadingElement.style.display = "none";
        addFormElement.style.display = "";
      }
    }

    function formatDate(date) {
      const day = date.getDate();
      const month = date.toLocaleString("ru-RU", { month: "long" });
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, "0");
      const minutes = String(date.getMinutes()).padStart(2, "0");
      return `${day} ${month} ${year}, ${hours}:${minutes}`;
    }

    function escapeHTML(str) {
      return str
        .replaceAll("&", "&amp;")
        .replaceAll("<", "<")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderComments() {
      commentsList.innerHTML = "";

      comments.forEach((comment, index) => {
        const commentHTML = `
      <li class="comment" data-index="${index}">
        <div class="comment-header">
          <div class="comment-author">${escapeHTML(comment.author)}</div>
          <div>${formatDate(comment.date)}</div>
        </div>
        <div class="comment-body">
          <div class="comment-text">
            ${escapeHTML(comment.text).replace(/\n/g, "<br>")}
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span class="likes-counter">${comment.likes}</span>
            <button class="like-button ${
              comment.isLiked ? "-active-like" : ""
            }" data-index="${index}"></button>
          </div>
        </div>
      </li>
    `;
        commentsList.insertAdjacentHTML("beforeend", commentHTML);
      });

      setupCommentReplyHandlers();
      setupLikeHandlers();
    }

    function setupCommentReplyHandlers() {
      document.querySelectorAll(".comment").forEach((commentElement) => {
        commentElement.addEventListener("click", function (event) {
          if (
            event.target.closest(".like-button") ||
            event.target.closest(".likes-counter")
          ) {
            return;
          }

          const index = this.getAttribute("data-index");
          const author = comments[index].author;
          const mention = `@${author} `;

          if (textInput.value.trim() === "") {
            textInput.value = mention;
          } else {
            let newValue = textInput.value.replace(/^@[^@\s]+\s?/g, "").trim();

            textInput.value = mention + (newValue ? newValue + " " : "");
          }

          textInput.focus();
        });
      });
    }

    function setupLikeHandlers() {
      document.querySelectorAll(".like-button").forEach((button) => {
        button.addEventListener("click", function (event) {
          event.stopPropagation();
          const index = this.getAttribute("data-index");

          if (comments[index].isLiked) {
            comments[index].likes--;
            comments[index].isLiked = false;
          } else {
            comments[index].likes++;
            comments[index].isLiked = true;
          }
          renderComments();
        });
      });
    }

    addButton.addEventListener("click", function () {
      postComment();
    });

    fetchComments();
  </script>
</html>
